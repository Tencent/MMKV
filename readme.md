# MMKV

[![PRs Welcome](https://img.shields.io/badge/PRs-welcome-brightgreen.svg)](http://git.code.oa.com/wechat-team/mmkv/merge_requests) [![Release Version](https://img.shields.io/badge/release-1.0.8-brightgreen.svg)](http://git.code.oa.com/wechat-team/mmkv/tags) [![WeChat Approved iOS](https://img.shields.io/badge/Wechat_Approved_iOS-1.0.8-brightgreen.svg)](http://git.code.oa.com/wechat-team/mmkv/blob/master/iOS/readme.md) [![WeChat Approved Android](https://img.shields.io/badge/Wechat_Approved_Android-1.0.8-brightgreen.svg)](http://git.code.oa.com/wechat-team/mmkv/blob/master/Android/readme.md) [![Platform](https://img.shields.io/badge/Platform-%20iOS%20%7C%20Android-brightgreen.svg)](http://git.code.oa.com/wechat-team/mmkv/wikis/home)

中文版本请参看[这里][mmkv-wiki]

MMKV is an **efficient**, **samll**, **easy-to-use** mobile key-value storage framework used in the WeChat application. It's currently available on iOS and Android.

# MMKV for iOS

## Features

* **Efficient**. MMKV uses mmap to keep memory synced with file, and protobuf to encode/decode values, making the most of iOS to achieve best performance.

  * **Multi-threaded concurrency**: MMKV supports concurrent read-read and read-write access.
  * **Baseline Performance Test**:
  
    ![](http://imgcache.oa.com/photos/31601/3b5a30acb12158f3a3de668452b4bac0.jpg)
    For more benchmark data, please refer to [our benchmark][Benchmark-iOS].

* **Easy-to-use**. You can use MMKV as you go, no configurations needed. All changes are saved immediately, no `synchronize` calls needed.

    ```objective-c
    MMKV* mmkv = [MMKV defaultMMKV];
    
    [mmkv setBool:YES forKey:@"bool"];
    BOOL bValue = [mmkv getBoolForKey:@"bool"];
    
    [mmkv setInt32:-1024 forKey:@"int32"];
    int32_t iValue = [mmkv getInt32ForKey:@"int32"];
    
    [mmkv setObject:@"hello, mmkv" forKey:@"string"];
    NSString* str = [mmkv getObjectOfClass:NSString.class forKey:@"string"];
    ```

* **Small**.

  * **A handful files**: MMKV contains encode/decode helpers and mmap logics and nothing more. It's really tidy.
 
  * **Less than 30K in binary size**: MMKV adds less than 30K per architecture on App size, and much less when zipped (ipa).

## Getting Started

### Prerequisites

* Apps using MMKV can target: iOS 8 or later.
* Xcode 9.0 or later.

### Installation

* **Via Cocoapods:**
  1. Install [CocoaPods](https://guides.cocoapods.org/using/getting-started.html);
  2. Open terminal, `cd` to your project directory, run `pod repo update` to make CocoaPods aware of the latest available MMKV versions;
  3. Edit your Podfile, add `pod 'MMKV', :git => 'http://git.code.oa.com/wechat-team/mmkv.git'` to your app target;
  4. Run `pod install`;
  5. Open the `.xcworkspace` file generated by CocoaPods;
  6. Add `#import <MMKV/MMKV.h>` to your source file and we are done.
* **Via Carthage:** 
  1. Install [Carthage][install-carthage];
  2. Edit your Cartfile, add `git "http://git.code.oa.com/wechat-team/mmkv.git" "master"`;
  3. Open terminal, `cd` to your project directory, run `carthage update`;
  4. Drag `MMKV.framework` from the appropriate platform directory in `Carthage/Build/` to the `Linked Binary and Libraries` section of your Xcode project’s `Build Phases` settings;
  5. On your application target's `Build Phases` settings tab, click the "+" icon and choose `New Run Script Phase`. Create a Run Script with  `carthage copy-frameworks`, add the paths to the framework under `Input Files`: `$(SRCROOT)/Carthage/Build/iOS/MMKV.framework`, and add the paths to the copied frameworks to the `Output Files`: `$(BUILT_PRODUCTS_DIR)/$(FRAMEWORKS_FOLDER_PATH)/MMKV.framework`;
  6. Add `#import <MMKV/MMKV.h>` to your source file and we are done.
* **Via Dynamic Framework**: 
  1. Getting source code from git repository:
     - `git clone http://git.code.oa.com/wechat-team/mmkv.git`
  2. Drag `MMKV.xcodeproj` in `iOS/MMKV/` into your project;
  3. Add `MMKV.xcodeproj` to the `Enbedded Binaries` section of your Xcode project's `General settings`; **Note that there are two frameworks here and the dynamic one should be chosen. You can check it at `Build Phases`->`Target Dependencies`. The right one is `MMKV` while `MMKV Static` is used for static lib.**
  4. Add `#import <MMKV/MMKV.h>` to your source file and we are done.
* **Via Static Framework:**
  1. Getting source code from git repository:
     - `git clone http://git.code.oa.com/wechat-team/mmkv.git`
  2. Drag `MMKV.xcodeproj ` in `iOS/MMKV/` into your project;
  3. Add `MMKV Static` to the `Target Dependencies` section of your Xcode project's `Build Phases` settings;
  4. Add `libMMKV Static.a`， `libz.tbd` to the `Linked Binary and Libraries` section of your Xcode project's `Build Phases` settings;
  5. Add `-all_load` and `-ObjC` to the `Other Linker Flags` section of your Xcode project's `Build Settings`.
  6. Add `#import <MMKV/MMKV.h>` to your source file and we are done.

## Tutorials

Tutorials can be found [here][iOS-tutorial].

## Documentations

* Documentations can be found on [our Wiki][mmkv-wiki].
* Performence data can be found on [our benchmark][Benchmark-iOS].

# MMKV for Android

## Features

* **Efficient**. MMKV uses mmap to keep memory synced with file, and protobuf to encode/decode values, making the most of Android to achieve best performance.
  * **Multi-Process concurrency**: MMKV supports concurrent read-read and read-write access between processes.
  * **Baseline Performance Test**:
      ![](http://imgcache.oa.com/photos/31601/o_bb215f7fd392321793e6564128d4bd03.jpg)
    For more benchmark data, please refer to [our benchmark][Benchmark-Android].

* **Easy-to-use**. You can use MMKV as you go, no configurations needed. All changes are saved immediately, no `sync`, no `apply` calls needed.

    ```Java
    import com.tencent.mmkv.MMKV;
    
    MMKV kv = MMKV.defaultMMKV();

    kv.encode("bool", true);
    boolean bValue = kv.decodeBool("bool");

    kv.encode("int", Integer.MIN_VALUE);
    int iValue = kv.decodeInt("int");

    kv.encode("string", "Hello from mmkv");
    String str = kv.decodeString("string");
    ```

* **Small**.

  * **A handful files**: MMKV contains process locks, encode/decode helpers and mmap logics and nothing more. It's really tidy.
 
  * **About 60K in binary size**: MMKV adds about 60K per architecture on App size, and much less when zipped (apk).



## Getting Started

### Prerequisites

* API level 16 and above are supported.
* NDK r16b and below (should you choose to build MMKV from source)

### Installation
* **Via Maven**
  1. Add the following lines to `build.gradle` on your app module:

     ```gradle
     repositories {
         maven {
             url "http://maven.oa.com/nexus/content/repositories/thirdparty"
         }
     }
     dependencies {
         implementation 'com.tencent:mmkv:1.0.8'
     }
     ```

     This will cause Gradle to download AAR package while building your application.

* **Via Prebuilt AAR Package**
  1. Download AAR package from release page;
  2. Import the AAR as new module. In Android Studio, select `File -> New -> New Module...` menu and choose `"Import JAR/AAR Package"`;
  3. Add a dependency on the new module. This can be done using `File -> Project Structure...` in Android Studio, or by adding following code to application's `build.gradle`:
  
     ```gradle
     dependencies {
         implementation project(':mmkv')
     }
     ```

* **Build from Source**
  1. Getting source code from git repository:
  
     ```
     git clone http://git.code.oa.com/wechat-team/mmkv.git
     cd mmkv
     ```
  
  2. Install [Android NDK r16b](https://developer.android.com/ndk/downloads/revision_history). If Gradle failed to find your SDK and/or 
NDK, you may need to create a file named `local.properties` on the `Android/MMKV/` directory 
with content:

     ```
     sdk.dir=path/to/sdk
     ndk.dir=path/to/ndk
     ```
     note: Starting from NDK r17, `ARMv5 (armeabi)` is not supported. You can use the latest NDK if your app doesn't need to support that architecture, by deleting this line in `Android/MMKV/mmkv/build.gradle`:
  
     ```gradle
     abiFilters 'armeabi', 'armeabi-v7a', 'arm64-v8a', 'x86', 'x86_64'
     ```
  3. Open `Android/MMKV` project in Android Studio and start building, or you can do it in terminal:
    
     ```
     cd Android/MMKV
     ./gradlew build
     ```
  
### Migrate from SharedPreferences

MMKV has interfaces very similar to Android SharedPreferences APIs. To migrate you application from SharedPreferences:

```java
    //SharedPreferences preferences = getSharedPreferences("myData", MODE_PRIVATE);
    // use mmkv just as SharedPreferences
    MMKV preferences = MMKV.mmkvWithID("myData");
    // migrate
    {
        SharedPreferences old_man = getSharedPreferences("myData", MODE_PRIVATE);
        preferences.importFromSharedPreferences(old_man);
        old_man.edit().clear().commit();
    }
    // use mmkv just as SharedPreferences
    boolean bValue = preferences.getBoolean("bool", false);
    int iValue = preferences.getInt("int", 0);
    String str = preferences.getString("string", null);
    
    SharedPreferences.Editor editor = preferences.edit();
    editor.putBoolean("bool", true);
    editor.putInt("int", Integer.MIN_VALUE);
    editor.putString("string", "hello, imported");
    // this is not needed
    //editor.commit();
```

## Documentations

* Documentations can be found on [our Wiki][mmkv-wiki].
* API references for Android can be found [here][mmkv-docs-android].

[install-carthage]: https://github.com/Carthage/Carthage#installing-carthage
[mmkv-wiki]: ./readme_cn.md
[mmkv-docs-ios]: http://git.code.oa.com/wechat-team/mmkv/wikis/home
[mmkv-docs-android]: http://git.code.oa.com/wechat-team/mmkv/wikis/home
[iOS-tutorial]: http://git.code.oa.com/wechat-team/mmkv/wikis/home/iOS-macOS-Tutorial
[Benchmark-iOS]: http://git.code.oa.com/wechat-team/mmkv/wikis/home/mmkv-iOS-benchmark
[Benchmark-Android]: http://git.code.oa.com/wechat-team/mmkv/wikis/home/mmkv-Android-benchmark
